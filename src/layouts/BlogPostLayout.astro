---
import Layout from '@/layouts/Layout.astro'
import type { CollectionEntry } from 'astro:content'
import { formatDateYMD } from '@/utils/format'
import { LOCALES, useTranslations, type Lang } from '@/utils/i18n'

interface Props {
    post: CollectionEntry<'blog'>
    posts: CollectionEntry<'blog'>[]
}

const { post, posts } = Astro.props
const locale = Astro.currentLocale as Lang
const t = useTranslations(locale)

// Next/Prev posts index calculation
const allPosts = posts.map(({ data: { title }, slug }) => {
    const [_, ...slugParts] = slug.split('/')
    return {
        title,
        slug: slugParts.join('/')
    }
})

const currentPostIndex = allPosts.findIndex((p) => post.slug.includes(p.slug))

const prevPost = currentPostIndex !== 0 ? allPosts[currentPostIndex - 1] : null
const nextPost = currentPostIndex !== allPosts.length ? allPosts[currentPostIndex + 1] : null

// Translations
const back = t({
    it: 'indietro',
    en: 'back'
})
const post_at = t({
    it: 'pubblicato il',
    en: 'posted at'
})
const last_modified_at = t({
    it: 'ultima modifica il',
    en: 'last modified at'
})
const read_in = t({
    en: 'leggi in',
    it: 'read in'
})
const prev_post = t({
    en: 'previous post',
    it: 'post precedente'
})
const next_post = t({
    en: 'next post',
    it: 'post successivo'
})
---

<Layout title={post.data.title} navbar={false}>
    <a rel="prefetch" class="panda-link mt-6" href="/">{back}</a>
    <style is:inline>
        /* notification */
        .notification p {
            margin-top: 0;
            margin-bottom: 0;
            padding: 0.5rem 1rem;
            font-size: small;
        }

        .notification-warning {
            background-color: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }

        .notification-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .notification-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .notification-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .dark .notification-warning {
            background-color: #856404;
            border-color: #ffeeba;
            color: #fff3cd;
        }

        .dark .notification-danger {
            background-color: #721c24;
            border-color: #f5c6cb;
            color: #f8d7da;
        }

        .dark .notification-success {
            background-color: #155724;
            border-color: #c3e6cb;
            color: #d4edda;
        }

        .dark .notification-info {
            background-color: #0c5460;
            border-color: #bee5eb;
            color: #d1ecf1;
        }
    </style>
    <div class="mt-6">
        <h1 class="text-4xl">{post.data.title}</h1>
        <div class="flex flex-row rounded-lg bg-stone-100 dark:bg-[var(--color-secondary-bg)] p-2 px-4">
            <span class="ml-2 mr-auto font-normal text-sm">
                {
                    post.data.langs
                        .filter((lang) => lang !== locale)
                        .map((lang) => (
                            <a href={`/${lang}/blog/${post.slug.split('/')[1]}`} class="text-sm mr-2 panda-link">
                                {`${read_in} ${LOCALES[lang].label}`}
                            </a>
                        ))
                }
            </span>
            <span class="ml-auto mr-2 text-sm font-normal">
                {post_at} {formatDateYMD(post.data.pubDate.toISOString(), locale)}</span
            >
        </div>
    </div>
    <article class="prose dark:prose-invert prose-stone max-w-prose mt-6">
        <slot />
    </article>
    {
        post.data.lastModified && post.data.pubDate !== post.data.lastModified && (
            <div class="mt-9 flex text-sm font-italic opacity-80">
                <span class="ml-auto">
                    {last_modified_at} {formatDateYMD(post.data.lastModified.toISOString(), locale)}
                </span>
            </div>
        )
    }

    <!-- Prev/Next posts navigation -->
    <div class="prev-next-posts">
        {
            prevPost && (
                <a href={`/${locale}/blog/${prevPost.slug}`} class="panda-link flex w-full gap-1">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-left flex-none"
                    >
                        <>
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M15 6l-6 6l6 6" />
                        </>
                    </svg>
                    <div>
                        <span>{prev_post}</span>
                        <div class="prev-post-title">{prevPost.title}</div>
                    </div>
                </a>
            )
        }
        {
            nextPost && (
                <a
                    href={`/${locale}/blog/${nextPost.slug}`}
                    class="panda-link flex w-full gap-1 justify-end text-right"
                >
                    <div>
                        <span>{next_post}</span>
                        <div class="next-post-title">{nextPost.title}</div>
                    </div>
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-right flex-none"
                    >
                        <>
                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                            <path d="M9 6l6 6l-6 6" />
                        </>
                    </svg>
                </a>
            )
        }
    </div>
</Layout>

<style>
    div.prev-next-posts {
        @apply grid grid-cols-1 gap-6 sm:grid-cols-2
        bg-stone-100 dark:bg-[var(--color-secondary-bg)]
        p-2 px-4
        rounded-lg
        my-12;
    }
    div.prev-post-title,
    div.next-post-title {
        @apply text-sm font-inter mt-2;
    }
</style>
